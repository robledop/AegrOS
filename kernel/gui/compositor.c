#include <compositor.h>
#include <kernel_heap.h>
#include <printf.h>
#include <string.h>
#include <vbe.h>

int window_count               = 0;
window_t *windows[MAX_WINDOWS] = {};

unsigned char computer_icon_1[32 * 32] = {
    0xfa, 0xfa, 0xfa, 0xfa, 0xfa, 0xfa, 0xfa, 0xfa, 0x92, 0x92, 0x92, 0x92, 0xfa, 0xfa, 0xfa, 0xfa, 0xfa, 0xfa, 0xfa,
    0xfa, 0xfa, 0xfa, 0xfa, 0xfa, 0xfa, 0xfa, 0xfa, 0xfa, 0xfa, 0xfa, 0xfa, 0xfa, 0xfa, 0xfa, 0xfa, 0xfa, 0xfa, 0xfa,
    0x92, 0x92, 0xdb, 0xdb, 0xdb, 0xdb, 0x92, 0x92, 0xfa, 0xfa, 0xfa, 0xfa, 0xfa, 0xfa, 0xfa, 0xfa, 0xfa, 0xfa, 0xfa,
    0xfa, 0xfa, 0xfa, 0xfa, 0xfa, 0xfa, 0xfa, 0xfa, 0xfa, 0xfa, 0xfa, 0x92, 0x92, 0xdb, 0xdb, 0xdb, 0xdb, 0xdb, 0xdb,
    0xdb, 0xdb, 0x92, 0x92, 0x92, 0x92, 0x92, 0x92, 0x92, 0x92, 0xfa, 0xfa, 0xfa, 0xfa, 0xfa, 0xfa, 0xfa, 0xfa, 0xfa,
    0xfa, 0xfa, 0xfa, 0xfa, 0x92, 0xff, 0xff, 0xff, 0xff, 0xff, 0xdb, 0xdb, 0xdb, 0xdb, 0xdb, 0xdb, 0xdb, 0x92, 0x92,
    0xdb, 0xdb, 0xdb, 0xdb, 0x92, 0x92, 0xfa, 0xfa, 0xfa, 0xfa, 0xfa, 0xfa, 0xfa, 0xfa, 0xfa, 0xfa, 0xfa, 0x92, 0xff,
    0xdb, 0xdb, 0xdb, 0xdb, 0xff, 0xff, 0xdb, 0xdb, 0xdb, 0xdb, 0xdb, 0xdb, 0xdb, 0x92, 0x92, 0xdb, 0xdb, 0xdb, 0xdb,
    0x92, 0x92, 0x00, 0xfa, 0xfa, 0xfa, 0xfa, 0xfa, 0xfa, 0xfa, 0xfa, 0x92, 0xff, 0xdb, 0x00, 0x92, 0x92, 0xdb, 0xdb,
    0xff, 0xff, 0xdb, 0xdb, 0xdb, 0xdb, 0xdb, 0xdb, 0xdb, 0x92, 0x92, 0xdb, 0xdb, 0xdb, 0xdb, 0x92, 0x00, 0xfa, 0xfa,
    0xfa, 0xfa, 0xfa, 0xfa, 0xfa, 0x92, 0xff, 0xdb, 0x00, 0x02, 0x02, 0x92, 0x92, 0xdb, 0xdb, 0xff, 0xff, 0xdb, 0xdb,
    0xdb, 0xdb, 0xdb, 0xdb, 0xdb, 0x00, 0xdb, 0x92, 0x92, 0x92, 0x00, 0xfa, 0xfa, 0xfa, 0xfa, 0xfa, 0xfa, 0xfa, 0x92,
    0xff, 0xdb, 0x00, 0x03, 0x03, 0x02, 0x02, 0x92, 0x92, 0xdb, 0xdb, 0xff, 0xff, 0xdb, 0xdb, 0xdb, 0x92, 0x92, 0x00,
    0x92, 0x92, 0x92, 0x92, 0x00, 0xfa, 0xfa, 0xfa, 0xfa, 0xfa, 0xfa, 0xfa, 0x92, 0xff, 0xdb, 0x00, 0x03, 0x03, 0x03,
    0x03, 0x02, 0x02, 0x92, 0x92, 0xdb, 0xdb, 0xdb, 0x92, 0x92, 0x92, 0x92, 0x00, 0x92, 0x92, 0x92, 0x92, 0x00, 0xfa,
    0xfa, 0xfa, 0xfa, 0xfa, 0xfa, 0xfa, 0x92, 0xff, 0xdb, 0x00, 0x03, 0x03, 0x03, 0x1f, 0x03, 0x03, 0x02, 0x02, 0x92,
    0x92, 0xdb, 0x92, 0x92, 0x92, 0x92, 0x00, 0x92, 0x92, 0x92, 0x92, 0x00, 0xfa, 0xfa, 0xfa, 0xfa, 0xfa, 0xfa, 0xfa,
    0x92, 0xff, 0xdb, 0x00, 0x03, 0x1f, 0x03, 0x1f, 0x03, 0x03, 0x1f, 0x03, 0x02, 0x02, 0xdb, 0x92, 0x92, 0x92, 0x92,
    0x00, 0x92, 0x92, 0x92, 0x92, 0x00, 0xfa, 0xfa, 0xfa, 0xfa, 0xfa, 0xfa, 0xfa, 0x92, 0xff, 0xdb, 0x00, 0x03, 0x03,
    0x1f, 0xff, 0x03, 0x1f, 0x03, 0x03, 0x03, 0x02, 0xdb, 0x92, 0x92, 0x92, 0x92, 0x00, 0x92, 0x92, 0x92, 0x92, 0x00,
    0xfa, 0xfa, 0xfa, 0xfa, 0xfa, 0xfa, 0xfa, 0x92, 0xff, 0xdb, 0x00, 0x03, 0x1f, 0x03, 0xfc, 0x1f, 0x03, 0x03, 0x03,
    0x03, 0x02, 0xdb, 0x92, 0x92, 0x92, 0x92, 0x00, 0x92, 0x92, 0x92, 0x92, 0x00, 0xfa, 0xfa, 0xfa, 0xfa, 0xfa, 0xfa,
    0xfa, 0x92, 0xff, 0xdb, 0x00, 0x03, 0x03, 0x03, 0x1f, 0x03, 0x03, 0x03, 0x03, 0x03, 0x02, 0xdb, 0x92, 0x92, 0x92,
    0x92, 0x00, 0x92, 0x92, 0x92, 0x92, 0x00, 0xfa, 0xfa, 0xfa, 0xfa, 0xfa, 0xfa, 0xfa, 0x92, 0xff, 0xdb, 0x00, 0x02,
    0x03, 0x03, 0x1f, 0x03, 0x1f, 0x03, 0x03, 0x03, 0x02, 0xdb, 0x92, 0x92, 0x92, 0x92, 0x00, 0x92, 0x92, 0x92, 0x92,
    0x00, 0xfa, 0xfa, 0xfa, 0xfa, 0xfa, 0xfa, 0xfa, 0x92, 0xdb, 0x92, 0x92, 0x92, 0x02, 0x02, 0x03, 0x03, 0x03, 0x03,
    0x03, 0x03, 0x02, 0xdb, 0x92, 0x92, 0x92, 0x92, 0x00, 0x92, 0x92, 0x92, 0x92, 0x00, 0xfa, 0xfa, 0xfa, 0xfa, 0xfa,
    0xfa, 0xfa, 0x92, 0x00, 0xdb, 0xdb, 0xdb, 0x92, 0x92, 0x02, 0x02, 0x03, 0x03, 0x03, 0x03, 0x02, 0xdb, 0x92, 0x92,
    0x92, 0x92, 0x00, 0x92, 0x92, 0x92, 0x00, 0xfa, 0xfa, 0xfa, 0xfa, 0xfa, 0xfa, 0xfa, 0x92, 0xdb, 0xdb, 0x00, 0x00,
    0xdb, 0xdb, 0xdb, 0x92, 0x92, 0x02, 0x02, 0x03, 0x03, 0x02, 0xdb, 0x92, 0x92, 0x92, 0x92, 0x00, 0x92, 0x92, 0x00,
    0xfa, 0xfa, 0xfa, 0xfa, 0xfa, 0xfa, 0xfa, 0xfa, 0x92, 0xff, 0xff, 0xdb, 0xdb, 0x00, 0x00, 0xdb, 0xdb, 0xdb, 0x92,
    0x92, 0x02, 0x02, 0x02, 0xdb, 0x92, 0x92, 0x92, 0x92, 0x00, 0x92, 0x00, 0x00, 0xfa, 0xfa, 0xfa, 0xfa, 0xfa, 0xfa,
    0xfa, 0xfa, 0x92, 0xff, 0xdb, 0xff, 0xff, 0xdb, 0xdb, 0x00, 0x00, 0xdb, 0xdb, 0xdb, 0x92, 0x92, 0x02, 0xdb, 0x92,
    0x92, 0x92, 0x92, 0x00, 0x00, 0x92, 0x92, 0x00, 0x00, 0xfa, 0xfa, 0xfa, 0xfa, 0xfa, 0xfa, 0x92, 0xff, 0xdb, 0xdb,
    0xdb, 0xff, 0xff, 0xdb, 0xdb, 0x00, 0x00, 0xdb, 0xdb, 0xdb, 0x92, 0xdb, 0x92, 0x92, 0x92, 0x92, 0x00, 0x92, 0x92,
    0x92, 0x92, 0x92, 0x00, 0xfa, 0xfa, 0xfa, 0xfa, 0xfa, 0x92, 0xff, 0xdb, 0x1c, 0x1c, 0xdb, 0xdb, 0xff, 0xff, 0xdb,
    0xdb, 0x00, 0x00, 0xdb, 0xdb, 0xdb, 0x92, 0x92, 0x92, 0x92, 0x00, 0x92, 0x92, 0x92, 0xdb, 0xdb, 0x00, 0xfa, 0xfa,
    0xfa, 0xfa, 0xfa, 0x92, 0xff, 0xdb, 0x10, 0x10, 0xdb, 0xdb, 0xdb, 0xdb, 0xff, 0xff, 0xdb, 0xdb, 0x00, 0x00, 0xdb,
    0x92, 0x92, 0x00, 0x00, 0x92, 0x92, 0xdb, 0xdb, 0x92, 0x92, 0x00, 0xfa, 0xfa, 0xfa, 0xfa, 0xfa, 0xfa, 0x00, 0x00,
    0xdb, 0xdb, 0xdb, 0xdb, 0xdb, 0xdb, 0xdb, 0xdb, 0xff, 0xff, 0xdb, 0xdb, 0x00, 0x00, 0x00, 0x92, 0x92, 0xdb, 0xdb,
    0x92, 0x92, 0x92, 0x92, 0x00, 0xfa, 0xfa, 0xfa, 0xfa, 0xfa, 0xfa, 0xfa, 0xfa, 0x00, 0x00, 0xdb, 0xdb, 0xdb, 0xdb,
    0xdb, 0xdb, 0xdb, 0xdb, 0xff, 0xff, 0xdb, 0x92, 0x92, 0xdb, 0xdb, 0x92, 0x92, 0x92, 0x92, 0x92, 0x92, 0x00, 0xfa,
    0xfa, 0xfa, 0xfa, 0xfa, 0xfa, 0xfa, 0xfa, 0xfa, 0xfa, 0x00, 0x00, 0xdb, 0xdb, 0xdb, 0xdb, 0xdb, 0xdb, 0xdb, 0xdb,
    0xff, 0xdb, 0xdb, 0x92, 0x92, 0x92, 0x92, 0x92, 0x92, 0x92, 0x92, 0x00, 0xfa, 0xfa, 0xfa, 0xfa, 0xfa, 0xfa, 0xfa,
    0xfa, 0xfa, 0xfa, 0xfa, 0xfa, 0x00, 0x00, 0xdb, 0xdb, 0xdb, 0xdb, 0xdb, 0xdb, 0xdb, 0x92, 0x92, 0x92, 0x92, 0x92,
    0x92, 0x92, 0x92, 0x00, 0x00, 0xfa, 0xfa, 0xfa, 0xfa, 0xfa, 0xfa, 0xfa, 0xfa, 0xfa, 0xfa, 0xfa, 0xfa, 0xfa, 0xfa,
    0xfa, 0x00, 0x00, 0xdb, 0xdb, 0xdb, 0xdb, 0xdb, 0x92, 0x92, 0x92, 0x92, 0x92, 0x92, 0x00, 0x00, 0xfa, 0xfa, 0xfa,
    0xfa, 0xfa, 0xfa, 0xfa, 0xfa, 0xfa, 0xfa, 0xfa, 0xfa, 0xfa, 0xfa, 0xfa, 0xfa, 0xfa, 0xfa, 0xfa, 0x00, 0x00, 0xdb,
    0xdb, 0xdb, 0x92, 0x92, 0x92, 0x92, 0x00, 0x00, 0xfa, 0xfa, 0xfa, 0xfa, 0xfa, 0xfa, 0xfa, 0xfa, 0xfa, 0xfa, 0xfa,
    0xfa, 0xfa, 0xfa, 0xfa, 0xfa, 0xfa, 0xfa, 0xfa, 0xfa, 0xfa, 0xfa, 0xfa, 0x00, 0x00, 0xdb, 0x92, 0x92, 0x00, 0x00,
    0xfa, 0xfa, 0xfa, 0xfa, 0xfa, 0xfa, 0xfa, 0xfa, 0xfa, 0xfa, 0xfa, 0xfa, 0xfa, 0xfa, 0xfa, 0xfa, 0xfa, 0xfa, 0xfa,
    0xfa, 0xfa, 0xfa, 0xfa, 0xfa, 0xfa, 0xfa, 0xfa, 0x00, 0x00, 0x00, 0xfa, 0xfa, 0xfa, 0xfa, 0xfa, 0xfa, 0xfa, 0xfa,
    0xfa, 0xfa, 0xfa, 0xfa, 0xfa, 0xfa, 0xfa, 0xfa, 0xfa, 0xfa, 0xfa, 0xfa, 0xfa, 0xfa, 0xfa, 0xfa, 0xfa, 0xfa, 0xfa,
    0xfa, 0xfa, 0xfa, 0xfa, 0xfa, 0xfa, 0xfa, 0xfa, 0xfa, 0xfa, 0xfa, 0xfa, 0xfa, 0xfa, 0xfa, 0xfa, 0xfa};

window_t *window_create(char *name, int x, int y, int width, int height)
{
    if (window_count >= MAX_WINDOWS) {
        printf("Cannot create more than %d windows\n", MAX_WINDOWS);
        return nullptr;
    }

    auto w = (window_t *)kzalloc(sizeof(window_t));
    strncpy(w->name, name, 20);
    w->x      = x;
    w->y      = y;
    w->width  = width;
    w->height = height;

    windows[window_count] = w;
    window_count++;

    return w;
}

void window_destroy(window_t *window)
{
    if (window == nullptr) {
        return;
    }

    for (int i = 0; i < window_count; i++) {
        if (windows[i] == window) {
            kfree(window);
            windows[i] = nullptr;
            // Shift remaining windows
            for (int j = i; j < window_count - 1; j++) {
                windows[j] = windows[j + 1];
            }
            windows[window_count - 1] = nullptr;
            window_count--;
            return;
        }
    }
}

void window_draw(window_t *window)
{
    int x = window->x;
    int y = window->y;
    int w = window->width;
    int h = window->height;

    vesa_fillrect(x, y, w, h, 0xFFFFFF);
    vesa_fillrect(x + 1, y + 1, w - 2, h - 2, 0x00CCCC);
    vesa_fillrect(x + 2, y + 2, w - 4, h - 4, 0xFFCCCC);

    // Title bar
    vesa_fillrect(x + 1, y + 1, w - 2, 18, 0x00CCCC);
    vesa_print_string(window->name, (int)strlen(window->name), x + 10, y + 5, 0xFFFFFF, 0x00CCCC);

    vesa_puticon32(x + 2, y + 20, computer_icon_1);
}

void draw_windows()
{
    for (int i = 0; i < window_count; i++) {
        window_draw(windows[i]);
    }
}

bool window_was_clicked(window_t *window, int x, int y)
{
    if (window == nullptr) {
        return false;
    }

    if (x >= window->x && x <= window->x + window->width && y >= window->y && y <= window->y + window->height) {
        window_print_message(window, "You clicked me!");
        return true;
    }

    return false;
}

void window_print_message(window_t *window, char *message)
{
    auto message_length = strlen(message);
    auto center_x       = window->x + window->width / 2 - (message_length * 8) / 2;
    auto center_y       = window->y + window->height / 2;
    vesa_print_string(message, (int)strlen(message), (int)center_x, center_y, 0x000000, 0xFFCCCC);
}
